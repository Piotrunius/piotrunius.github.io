name: Update GitHub Stats

on:
  schedule:
    # Odświeża się co 15 minut
    - cron: '*/15 * * * *'
  push:
    branches:
      - main
  workflow_dispatch: # Możesz też uruchomić ręcznie

# Zapobiega nakładaniu się na siebie wielu uruchomień
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch GitHub Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID64: ${{ secrets.STEAM_ID64 }}
        run: |
          node -e "
          const githubUsername = 'Piotrunius';
          const githubToken = process.env.GITHUB_TOKEN;
          const steamKey = process.env.STEAM_API_KEY;
          const steamId = '76561199034113344';

          async function fetchStats() {
            const headers = githubToken ? { 'Authorization': \`token \${githubToken}\` } : {};

            try {
              // --- GITHUB DATA ---
              const userResp = await fetch(\`https://api.github.com/users/\${githubUsername}\`, { headers });
              const user = await userResp.json();

              // Repositories
              let allRepos = [];
              let page = 1;
              let hasMore = true;
              while (hasMore) {
                const reposResp = await fetch(\`https://api.github.com/users/\${githubUsername}/repos?page=\${page}&per_page=100\`, { headers });
                const repos = await reposResp.json();
                if (!Array.isArray(repos) || repos.length === 0) break;
                allRepos = allRepos.concat(repos);
                hasMore = repos.length === 100;
                page++;
              }

              // Starred repos
              let allStarred = [];
              page = 1;
              hasMore = true;
              const starHeaders = { ...headers, 'Accept': 'application/vnd.github.star+json' };
              while (hasMore) {
                const starredResp = await fetch(\`https://api.github.com/users/\${githubUsername}/starred?page=\${page}&per_page=100\`, { headers: starHeaders });
                const starred = await starredResp.json();
                if (!Array.isArray(starred) || starred.length === 0) break;
                allStarred = allStarred.concat(starred);
                hasMore = starred.length === 100;
                page++;
              }

              // Commits
              let allCommits = [];
              for (const repo of allRepos.slice(0, 10)) {
                const commitsResp = await fetch(\`https://api.github.com/repos/\${githubUsername}/\${repo.name}/commits?per_page=5\`, { headers });
                const commits = await commitsResp.json();
                if (Array.isArray(commits)) {
                  allCommits = allCommits.concat(commits.map(c => ({
                    message: c.commit.message.split('\\n')[0],
                    repo: repo.name,
                    author: c.commit.author.name,
                    date: c.commit.author.date,
                    url: c.html_url
                  })));
                }
              }
              allCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

              const commitsCountResp = await fetch(\`https://api.github.com/search/commits?q=author:\${githubUsername}&per_page=1\`, {
                headers: { ...headers, 'Accept': 'application/vnd.github.cloak-preview' }
              });
              const commitsData = await commitsCountResp.json();
              const totalCommits = commitsData.total_count || 0;

              // --- STEAM DATA ---
              let steamData = { personastate: 0, gameextrainfo: null };
              if (steamKey && steamId) {
                try {
                  const steamResp = await fetch(\`http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=\${steamKey}&steamids=\${steamId}\`);
                  const steamJson = await steamResp.json();
                  if (steamJson.response && steamJson.response.players && steamJson.response.players[0]) {
                    const p = steamJson.response.players[0];
                    steamData = {
                      personastate: p.personastate,
                      gameextrainfo: p.gameextrainfo || null,
                      avatar: p.avatarmedium,
                      timecreated: p.timecreated,
                      lastlogoff: p.lastlogoff
                    };
                  }
                } catch (se) { console.error('Steam fetch error:', se.message); }
              }

              // Prepare stats
              const stats = {
                steam: steamData,
                summary: {
                  projects: user.public_repos || 0,
                  starredCount: allStarred.length,
                  commits: totalCommits,
                  followers: user.followers || 0,
                  following: user.following || 0
                },
                recentCommits: allCommits.slice(0, 10),
                starred: allStarred.slice(0, 50).map(item => ({
                  name: item.repo.name,
                  owner: item.repo.owner.login,
                  url: item.repo.html_url,
                  stars: item.repo.stargazers_count || 0,
                  language: item.repo.language,
                  description: item.repo.description,
                  starredAt: item.starred_at
                })),
                lastUpdate: new Date().toISOString()
              };

              const fs = require('fs');
              fs.writeFileSync('assets/github-stats.json', JSON.stringify(stats, null, 2));
              fs.writeFileSync('github-stats.json', JSON.stringify(stats, null, 2));
              console.log('Stats updated successfully');
            } catch (e) {
              console.error('Error fetching stats:', e.message);
              process.exit(1);
            }
          }

          fetchStats();
          "

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Add both files
          git add assets/github-stats.json github-stats.json
          git commit -m "chore: update github stats" || echo "No changes to commit"
          git push
