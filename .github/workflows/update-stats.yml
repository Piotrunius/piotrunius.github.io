name: Update GitHub Stats

on:
  schedule:
    # Odświeża się co 6 godzin
    - cron: '0 */6 * * *'
  workflow_dispatch: # Możesz też uruchomić ręcznie

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch GitHub Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const githubUsername = 'Piotrunius';
          const token = process.env.GITHUB_TOKEN;

          async function fetchStats() {
            const headers = token ? { 'Authorization': \`token \${token}\` } : {};

            try {
              // User info
              const userResp = await fetch(\`https://api.github.com/users/\${githubUsername}\`, { headers });
              const user = await userResp.json();

              // Repositories (paginated)
              let allRepos = [];
              let page = 1;
              let hasMore = true;
              while (hasMore) {
                const reposResp = await fetch(\`https://api.github.com/users/\${githubUsername}/repos?page=\${page}&per_page=100\`, { headers });
                const repos = await reposResp.json();
                if (!Array.isArray(repos) || repos.length === 0) break;
                allRepos = allRepos.concat(repos);
                hasMore = repos.length === 100;
                page++;
              }

              // User's starred repos (paginated)
              let allStarred = [];
              page = 1;
              hasMore = true;
              while (hasMore) {
                const starredResp = await fetch(\`https://api.github.com/users/\${githubUsername}/starred?page=\${page}&per_page=100\`, { headers });
                const starred = await starredResp.json();
                if (!Array.isArray(starred) || starred.length === 0) break;
                allStarred = allStarred.concat(starred);
                hasMore = starred.length === 100;
                page++;
              }

              // Commits (get recent commits across all repos)
              let allCommits = [];
              for (const repo of allRepos.slice(0, 10)) {
                const commitsResp = await fetch(\`https://api.github.com/repos/\${githubUsername}/\${repo.name}/commits?per_page=5\`, { headers });
                const commits = await commitsResp.json();
                if (Array.isArray(commits)) {
                  allCommits = allCommits.concat(commits.map(c => ({
                    message: c.commit.message.split('\\n')[0],
                    repo: repo.name,
                    author: c.commit.author.name,
                    date: c.commit.author.date,
                    url: c.html_url
                  })));
                }
              }
              allCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

              // Total commits count
              const commitsCountResp = await fetch(\`https://api.github.com/search/commits?q=author:\${githubUsername}&per_page=1\`, {
                headers: { ...headers, 'Accept': 'application/vnd.github.cloak-preview' }
              });
              const commitsData = await commitsCountResp.json();
              const totalCommits = commitsData.total_count || 0;

              // Prepare stats
              const stats = {
                summary: {
                  projects: user.public_repos || 0,
                  starredCount: allStarred.length,
                  commits: totalCommits,
                  followers: user.followers || 0,
                  following: user.following || 0
                },
                repos: allRepos.map(r => ({
                  name: r.name,
                  url: r.html_url,
                  description: r.description,
                  stars: r.stargazers_count || 0,
                  language: r.language,
                  createdAt: r.created_at,
                  updatedAt: r.updated_at
                })),
                recentCommits: allCommits.slice(0, 10),
                starred: allStarred.slice(0, 50).map(r => ({
                  name: r.name,
                  owner: r.owner.login,
                  url: r.html_url,
                  stars: r.stargazers_count || 0,
                  language: r.language,
                  description: r.description,
                  starredAt: new Date().toISOString()
                })),
                lastUpdate: new Date().toISOString()
              };

              const fs = require('fs');
              // Save to both locations to ensure compatibility
              fs.writeFileSync('assets/github-stats.json', JSON.stringify(stats, null, 2));
              fs.writeFileSync('github-stats.json', JSON.stringify(stats, null, 2));
              
              console.log('Stats updated successfully');
              console.log('Projects:', stats.summary.projects);
              console.log('Starred repos:', stats.summary.starredCount);
              console.log('Total commits:', stats.summary.commits);
            } catch (e) {
              console.error('Error fetching stats:', e.message);
              process.exit(1);
            }
          }

          fetchStats();
          "

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Add both files
          git add assets/github-stats.json github-stats.json
          git commit -m "chore: update github stats" || echo "No changes to commit"
          git push
