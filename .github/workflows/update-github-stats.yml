name: Update GitHub Stats

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  update-github:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch GitHub Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const githubUsername = 'Piotrunius';
          const githubToken = process.env.GITHUB_TOKEN;

          async function fetchStats() {
            const headers = githubToken ? { 'Authorization': `token ${githubToken}` } : {};

            try {
              // --- GITHUB DATA ---
              const userResp = await fetch(`https://api.github.com/users/${githubUsername}`, { headers });
              const user = await userResp.json();

              // Repositories
              let allRepos = [];
              let page = 1;
              let hasMore = true;
              while (hasMore) {
                const reposResp = await fetch(`https://api.github.com/users/${githubUsername}/repos?page=${page}&per_page=100`, { headers });
                const repos = await reposResp.json();
                if (!Array.isArray(repos) || repos.length === 0) break;
                allRepos = allRepos.concat(repos);
                hasMore = repos.length === 100;
                page++;
              }

              // Starred repos
              let allStarred = [];
              page = 1;
              hasMore = true;
              const starHeaders = { ...headers, 'Accept': 'application/vnd.github.star+json' };
              while (hasMore) {
                const starredResp = await fetch(`https://api.github.com/users/${githubUsername}/starred?page=${page}&per_page=100`, { headers: starHeaders });
                const starred = await starredResp.json();
                if (!Array.isArray(starred) || starred.length === 0) break;
                allStarred = allStarred.concat(starred);
                hasMore = starred.length === 100;
                page++;
              }

              // Commits
              let allCommits = [];
              for (const repo of allRepos.slice(0, 10)) {
                const commitsResp = await fetch(`https://api.github.com/repos/${githubUsername}/${repo.name}/commits?per_page=5`, { headers });
                const commits = await commitsResp.json();
                if (Array.isArray(commits)) {
                  allCommits = allCommits.concat(commits.map(c => ({
                    message: c.commit.message.split('\n')[0],
                    repo: repo.name,
                    author: c.commit.author.name,
                    date: c.commit.author.date,
                    url: c.html_url
                  })));
                }
              }
              allCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

              const commitsCountResp = await fetch(`https://api.github.com/search/commits?q=author:${githubUsername}&per_page=1`, {
                headers: { ...headers, 'Accept': 'application/vnd.github.cloak-preview' }
              });
              const commitsData = await commitsCountResp.json();
              const totalCommits = commitsData.total_count || 0;

              // Prepare stats
              const stats = {
                summary: {
                  projects: user.public_repos || 0,
                  starredCount: allStarred.length,
                  commits: totalCommits
                },
                recentCommits: allCommits.slice(0, 10),
                starred: allStarred.slice(0, 50).map(item => ({
                  name: item.repo.name,
                  owner: item.repo.owner.login,
                  url: item.repo.html_url,
                  stars: item.repo.stargazers_count || 0,
                  language: item.repo.language,
                  description: item.repo.description,
                  starredAt: item.starred_at
                })),
                lastUpdate: new Date().toISOString()
              };

              const fs = require('fs');
              const path = require('path');
              const filePath = path.join('./data', 'github-stats.json');
              
              // Optimization: Check if data changed (ignoring lastUpdate)
              if (fs.existsSync(filePath)) {
                const oldData = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                const newDataCompare = { ...stats, lastUpdate: oldData.lastUpdate };
                if (JSON.stringify(oldData) === JSON.stringify(newDataCompare)) {
                  console.log('No significant changes in GitHub stats. Skipping update.');
                  process.exit(0);
                }
              }

              if (!fs.existsSync('./data')) fs.mkdirSync('./data');
              fs.writeFileSync(filePath, JSON.stringify(stats, null, 2));
              console.log('GitHub stats updated successfully');
            } catch (e) {
              console.error('Error fetching GitHub stats:', e.message);
              process.exit(1);
            }
          }

          fetchStats();
          "

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/github-stats.json
          git commit -m "chore: update github stats" || echo "No changes to commit"
          git push
