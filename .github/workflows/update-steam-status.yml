name: Update Steam Status

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  update-steam:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch Steam Status
        env:
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID64: ${{ secrets.STEAM_ID64 }}
        run: |
          node -e "
          const steamKey = process.env.STEAM_API_KEY;
          const steamId = process.env.STEAM_ID64 || '76561199034113344';

          async function fetchSteamStatus() {
            let steamData = { personastate: 0, gameextrainfo: null, game_count: 0 };
            if (steamKey && steamId) {
              try {
                // Player Summary
                const steamResp = await fetch(`http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${steamKey}&steamids=${steamId}`);
                const steamJson = await steamResp.json();
                
                // Owned Games (for game count and total playtime)
                const gamesResp = await fetch(`http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${steamKey}&steamid=${steamId}&include_appinfo=0&include_played_free_games=1`);
                const gamesJson = await gamesResp.json();
                
                let totalPlaytime = 0;
                if (gamesJson.response && gamesJson.response.games) {
                  totalPlaytime = gamesJson.response.games.reduce((acc, game) => acc + (game.playtime_forever || 0), 0);
                }

                if (steamJson.response && steamJson.response.players && steamJson.response.players[0]) {
                  const p = steamJson.response.players[0];
                  steamData = {
                    personastate: p.personastate,
                    gameextrainfo: p.gameextrainfo || null,
                    avatar: p.avatarmedium,
                    timecreated: p.timecreated,
                    lastlogoff: p.lastlogoff,
                    game_count: gamesJson.response?.game_count || 0,
                    total_playtime: Math.round(totalPlaytime / 60) // Convert to hours
                  };
                }

                const stats = {
                  steam: steamData,
                  lastUpdate: new Date().toISOString()
                };

                const fs = require('fs');
                const path = require('path');
                const filePath = path.join('./data', 'steam-status.json');

                // Optimization: Only update if actual data changed (ignoring lastUpdate)
                if (fs.existsSync(filePath)) {
                  const oldData = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                  const newDataCompare = { ...stats, lastUpdate: oldData.lastUpdate };
                  if (JSON.stringify(oldData) === JSON.stringify(newDataCompare)) {
                    console.log('No change in Steam status. Skipping commit.');
                    process.exit(0);
                  }
                }

                if (!fs.existsSync('./data')) fs.mkdirSync('./data');
                fs.writeFileSync(filePath, JSON.stringify(stats, null, 2));
                console.log('Steam status updated successfully');
              } catch (se) { 
                console.error('Steam fetch error:', se.message); 
                process.exit(1);
              }
            } else {
              console.error('Steam API Key or Steam ID missing');
              process.exit(1);
            }
          }

          fetchSteamStatus();
          "

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/steam-status.json
          git commit -m "chore: update steam status" || echo "No changes to commit"
          git push
