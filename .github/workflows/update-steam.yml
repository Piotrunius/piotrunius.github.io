name: Update Steam Status

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: pages-flow
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Steam
        env:
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID64: ${{ secrets.STEAM_ID64 }}
        run: |
          cat << 'EOF' > update.js
          const fs = require('fs');
          const key = process.env.STEAM_API_KEY;
          const id = process.env.STEAM_ID64 || '76561199034113344';
          if (!key) {
            console.error('STEAM_API_KEY is missing');
            process.exit(1);
          }

          async function run() {
            try {
              const sR = await fetch(`http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${key}&steamids=${id}`);
              const sJ = await sR.json();
              const gR = await fetch(`http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${key}&steamid=${id}&include_appinfo=0&include_played_free_games=1`);
              const gJ = await gR.json();
              
              if (!sJ.response?.players?.[0]) {
                console.error('No player data found');
                process.exit(1);
              }

              const p = sJ.response.players[0];
              const stats = {
                steam: {
                  personastate: p.personastate,
                  gameextrainfo: p.gameextrainfo || null,
                  avatar: p.avatarmedium,
                  timecreated: p.timecreated,
                  lastlogoff: p.lastlogoff,
                  game_count: gJ.response?.game_count || 0,
                  total_playtime: Math.round((gJ.response?.games?.reduce((a,b)=>a+(b.playtime_forever||0),0)||0)/60)
                },
                lastUpdate: new Date().toISOString()
              };

              const path = './data/steam-status.json';
              if (fs.existsSync(path)) {
                const old = JSON.parse(fs.readFileSync(path, 'utf8'));
                if (JSON.stringify({...stats, lastUpdate: old.lastUpdate}) === JSON.stringify(old)) {
                  console.log('No change');
                  process.exit(0);
                }
              }
              if (!fs.existsSync('./data')) fs.mkdirSync('./data');
              fs.writeFileSync(path, JSON.stringify(stats, null, 2));
            } catch (e) { console.error(e); process.exit(1); }
          }
          run();
          EOF
          node update.js

      - name: Commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/steam-status.json
          if ! git diff --staged --quiet; then
            git commit -m "chore: update steam status"
            git pull --rebase origin main
            git push origin main
          fi