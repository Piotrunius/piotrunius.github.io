name: Update and Deploy

on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'data/**' # Nie uruchamiaj przy zmianach w danych (zapobiega pÄ™tli)
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-flow
  cancel-in-progress: false

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Stats
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID64: ${{ secrets.STEAM_ID64 }}
        run: |
          cat << 'EOF' > update.js
          const fs = require('fs');
          const isGithubTime = true;
          
          async function run() {
            if (!fs.existsSync('./data')) fs.mkdirSync('./data');
            
            // --- STEAM ---
            const sKey = process.env.STEAM_API_KEY;
            const sId = process.env.STEAM_ID64 || '76561199034113344';
            if (sKey) {
              try {
                const r1 = await fetch(`http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${sKey}&steamids=${sId}`);
                const j1 = await r1.json();
                const r2 = await fetch(`http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${sKey}&steamid=${sId}&include_appinfo=0&include_played_free_games=1`);
                const j2 = await r2.json();
                const p = j1.response.players[0];
                const stats = {
                  steam: {
                    personastate: p.personastate, gameextrainfo: p.gameextrainfo || null, avatar: p.avatarmedium,
                    timecreated: p.timecreated, lastlogoff: p.lastlogoff, game_count: j2.response?.game_count || 0,
                    total_playtime: Math.round((j2.response?.games?.reduce((a,b)=>a+(b.playtime_forever||0),0)||0)/60)
                  },
                  lastUpdate: new Date().toISOString()
                };
                fs.writeFileSync('./data/steam-status.json', JSON.stringify(stats, null, 2));
              } catch (e) { console.error('Steam error:', e.message); }
            }

            // --- GITHUB ---
            if (isGithubTime) {
              const gUser = 'Piotrunius';
              const gHeaders = process.env.GITHUB_TOKEN ? { 'Authorization': `token ${process.env.GITHUB_TOKEN}` } : {};
              try {
                const uR = await fetch(`https://api.github.com/users/${gUser}`, { headers: gHeaders });
                const uJ = await uR.json();
                const sR = await fetch(`https://api.github.com/users/${gUser}/starred?per_page=100`, { headers: {...gHeaders, 'Accept': 'application/vnd.github.star+json'} });
                const starred = await sR.json();
                const cR = await fetch(`https://api.github.com/search/commits?q=author:${gUser}`, { headers: {...gHeaders, 'Accept': 'application/vnd.github.cloak-preview'} });
                const cJ = await cR.json();
                const stats = {
                  summary: { projects: uJ.public_repos, starredCount: Array.isArray(starred) ? starred.length : 0, commits: cJ.total_count || 0 },
                  starred: Array.isArray(starred) ? starred.slice(0, 30).map(i => ({
                    name: i.repo.name, owner: i.repo.owner.login, url: i.repo.html_url, stars: i.repo.stargazers_count,
                    language: i.repo.language, description: i.repo.description, starredAt: i.starred_at
                  })) : [],
                  recentCommits: [], lastUpdate: new Date().toISOString()
                };
                
                // Fetch ALL user repositories
                const reposR = await fetch(`https://api.github.com/users/${gUser}/repos?per_page=100&sort=updated`, { headers: gHeaders });
                const repos = await reposR.json();
                
                // Get commits from all repos, not just top 5
                const allCommits = [];
                for (const r of repos.slice(0, 20)) { // Limit to 20 repos to avoid API rate limits
                  try {
                    const cr = await fetch(`https://api.github.com/repos/${r.owner.login}/${r.name}/commits?per_page=10&author=${gUser}`, { headers: gHeaders });
                    const cm = await cr.json();
                    if (Array.isArray(cm)) {
                      allCommits.push(...cm.map(c => ({
                        message: c.commit.message.split('\n')[0], 
                        repo: r.name, 
                        author: c.commit.author.name, 
                        date: c.commit.author.date, 
                        url: c.html_url
                      })));
                    }
                  } catch (e) {
                    console.log(`Skipping repo ${r.name}: ${e.message}`);
                  }
                }
                
                // Sort all commits by date and take the most recent ones
                stats.recentCommits = allCommits
                  .sort((a,b) => new Date(b.date) - new Date(a.date))
                  .slice(0, 50); // Keep top 50 most recent commits
                
                fs.writeFileSync('./data/github-stats.json', JSON.stringify(stats, null, 2));
              } catch (e) { console.error('GitHub error:', e.message); }
            }
          }
          run();
          EOF
          export IS_MANUAL="${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}"
          node update.js

      - name: Commit Changes
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/*.json
          if ! git diff --staged --quiet; then
            git commit -m "chore: automated stats update"
            git pull --rebase origin main
            git push origin main
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Pages
        if: steps.commit.outputs.changed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        if: steps.commit.outputs.changed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        if: steps.commit.outputs.changed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: actions/deploy-pages@v4
